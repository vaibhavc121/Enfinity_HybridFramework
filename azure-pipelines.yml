trigger:
- master

pool:
  vmImage: ubuntu-latest  # Use Ubuntu agent for Docker support

jobs:
  - job: Regression_Test
    displayName: "Regression testcase execution"
    steps:

    # Checkout code
    - checkout: self

    # Install Docker Compose (if needed)
    - script: |
        sudo apt-get update
        sudo apt-get install docker-compose -y
      displayName: 'Install Docker Compose'

    # Start Healenium backend & DB
    - script: |
        docker-compose -f helenium/docker-compose.yml up -d
      displayName: 'Start Healenium Services'

    # Wait for Healenium to be ready (optional but recommended)
    - script: |
        echo "Waiting for Healenium backend to be ready..."
        sleep 30
      displayName: 'Wait for Healenium to start'

    # Run Maven tests
    - task: Maven@4
      inputs:
        mavenPomFile: 'pom.xml'
        goals: 'test'
        publishJUnitResults: true
        testResultsFiles: '**/surefire-reports/TEST-*.xml'
        testRunTitle: 'Automation Engineer (SDET) - Vaibhav Chavan'
        javaHomeOption: 'JDKVersion'
        jdkVersionOption: '1.17'
        mavenVersionOption: 'Default'
        mavenAuthenticateFeed: false
        effectivePomSkip: false
        sonarQubeRunAnalysis: false
        checkStyleRunAnalysis: true
        pmdRunAnalysis: true
        findBugsRunAnalysis: true

    # Stop Docker containers after tests
    - script: |
        docker-compose -f helenium/docker-compose.yml down
      displayName: 'Stop Healenium Services'

    # Publish artifacts
    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'
        ArtifactName: 'drop'
        publishLocation: 'Container'
